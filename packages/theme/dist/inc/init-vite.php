<?php
/**
 * Initializes the inclusion of assets built by Vite.
 *
 * This script configures and loads the compiled assets generated by Vite,
 * ensuring that all necessary files are correctly integrated into the application.
 *
 * @since 1.0.0
 */

/**
 * スクリプトのエンキューラッパー
 */
function enque_script( $handle, $src ) {
	wp_enqueue_script(
		$handle,
		$src,
		'',
		true,
		true
	);
}

/**
 * スタイルのエンキューラッパー
 */
function enque_style( $handle, $src ) {
	wp_enqueue_style(
		$handle,
		$src,
		'',
		true
	);
}

/**
 * ページのスクリプトとスタイルのエンキュー
 */
function add_page_scripts_styles( $manifest, $handle ) {
	$page_manifest = $manifest[ 'src/scripts/' . $handle . '.ts' ];
	if ( ! is_array( $page_manifest ) ) {
		return;
	}

	// enqueue CSS files
	if ( ! empty( $page_manifest['css'] ) ) {
		foreach ( $page_manifest['css'] as $css_file ) {
			enque_style( $handle, DIST_URI . ASSETS_PATH . $css_file );
		}
	}

	// enqueue main JS file
	$js_file = $page_manifest['file'];
	if ( ! empty( $js_file ) ) {
		enque_script( $handle, DIST_URI . ASSETS_PATH . $js_file );
	}
}

/**
 * CORS HTTP header for development mode
 */
function cors_http_header() {
	header( 'Access-Control-Allow-Origin: *' );
}

/**
 * 各種スクリプトとスタイルのエンキュー
 */
add_action( 'wp_enqueue_scripts', 'add_scripts' );
function add_scripts() {
	global $page_name;

	// WP_DEBUGが有効かつ開発環境の場合はVite開発サーバーを使用
	// .envでWORDPRESS_DEBUG="true"を設定するとWP_DEBUGが有効になる
	$is_wp_debug = defined( 'WP_DEBUG' ) && WP_DEBUG;
	$is_dev_env  = defined( 'APPLICATION_ENV' ) && 'development' === constant( 'APPLICATION_ENV' );
	$is_vite_dev = $is_wp_debug && $is_dev_env;

	if ( $is_vite_dev ) {
		//develop mode
		add_action( 'send_headers', 'cors_http_header' );

		// add vite dev server
		enque_script( 'main', VITE_SERVER . VITE_ENTRY_POINT . 'main.ts' );

		// add page specific scripts
		// PAGE_SCRIPTS_STYLES_LISTを参照して、$page_nameと一致する場合にページごとのスクリプトを追加
		foreach ( PAGE_SCRIPTS_STYLES_LIST as $page ) {
			if ( $page['target_page_name'] === $page_name ) {
				$handle = $page['handle'];
				enque_script( $handle, VITE_SERVER . VITE_ENTRY_POINT . $handle . '.ts' );
				break;
			}
		}
	} else {
		// production mode, 'npm run build' must be executed in order to generate assets

		// read manifest.json to figure out what to enqueue
		// phpcs:ignore WordPress.WP.AlternativeFunctions.file_get_contents_file_get_contents
		$manifest = json_decode( file_get_contents( esc_url_raw( DIST_PATH . ASSETS_PATH . '.vite/manifest.json' ) ), true );

		// if there is no manifest file, do nothing
		if ( ! is_array( $manifest ) ) {
			return;
		}

		// get the first key of the manifest
		$manifest_key = array_keys( $manifest );
		if ( ! isset( $manifest_key[0] ) ) {
			return;
		}

		// add main scripts and styles
		add_page_scripts_styles( $manifest, 'main' );

		// add page specific scripts and styles
		// PAGE_SCRIPTS_STYLES_LISTを参照して、$page_nameと一致する場合にページごとのスクリプトとスタイルを追加
		foreach ( PAGE_SCRIPTS_STYLES_LIST as $page ) {
			if ( $page['target_page_name'] === $page_name ) {
				$handle = $page['handle'];
				add_page_scripts_styles( $manifest, $handle );
				break;
			}
		}
	}
}
